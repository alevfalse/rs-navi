<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Google Font-->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="css/all.css">
    
    <!-- My CSS -->
    <link rel="stylesheet" href="css/auth.css" type="text/css">

    <!-- Favicon-->
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico"/>

    <title>RS Navi - Login</title>
</head>
<body>
    
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-expand-md fixed-top" id="mainNavbar">
        <div class="container">
            <a href="/" class="navbar-brand"><span class="font-weight-bold">ROOM STAYIN</span> NAVIGATION</a>
            <button class="navbar-toggler" data-toggle="collapse" data-target="#navLinks" aria-label="Toggle navigation links">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navLinks">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item collapse show" id="switchRoleNav"><button type="button" class="btn nav-link bg-transparent" id="switchRoleButton">Login as Placeowner</button></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Main Section -->
    <main class="container">
        
        <div class="row justify-content-center">
            <div class="col-4 col-md-3 col-lg-2">
                <a href="/"><img class="img-fluid" src="images/logo_no_title.png" id="logo"></a>
            </div>
        </div>
        
        <!-- Login Form -->
        <div class="collapse show" id="login">
            <div class="collapse show" id="loginInner">
                <div class="row justify-content-center text-center mb-3">
                    <div class="col-8">
                        <div id="loginAsStudentTitle" class="collapse show">
                            <h2 class="display-6 text-white">Login as Student</h2>
                        </div>
                        <div id="loginAsPlaceownerTitle" class="collapse">
                            <h2 class="display-6 text-white">Login as Placeowner</h2>
                        </div>
                    </div>
                </div>
    
                <form method="POST" action="/login">
                    <div class="row justify-content-center text-center">
                        <div class="col-8 col-md-6 col-lg-5 col-xl-4 formFields">
                            <input type="email" class="form-control" placeholder="Email" required>
                            <div class="mb-3"></div>
                            <input type="password" class="form-control mb-3" placeholder="Password" required>
                            <input type="text" name="role" id="loginRole" value="student" hidden>
                            <button type="submit" class="btn btn-sm btn-primary px-4">Login</button>
                        </div>
                    </div>
                    <div class="row justify-content-center text-center mt-3 text-white">
                        <button type="button" class="btn text-white bg-transparent" id="switchToSignupButton">Don't have an account? Sign up!</button>
                    </div>
                </form>
            </div>

            <div class="row justify-content-center text-center text-white">
                <button type="button" class="btn text-white bg-transparent" id="forgotPasswordButton">Forgot Password</button>
            </div>
            <div class="collapse row justify-content-center text-center mt-3" id="forgot">
                <div class="col-8 col-md-6 col-lg-5 col-xl-4">
                    <form method="POST" action="/forgot">
                        <div class="formFields">
                            <input type="email" class="form-control" name="email" placeholder="Email" id="forgotPasswordEmail" required>
                            <div></div>
                            <button type="submit" class="btn btn-sm btn-primary mt-3">Reset Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Signup Form -->
        
        <div class="collapse" id="signup">
            <div class="collapse show" id="studentSignup">
                <div class="row justify-content-center text-center mb-3">
                    <div class="col-8">
                        <h2 class="display-5 text-white">Sign up as Student</h2>
                    </div>
                </div>
                <form method="POST" action="/signup">
                    <div class="row justify-content-center text-center">
                        <div class="col-8 col-md-6 col-lg-5 col-xl-4 formFields">

                            <input type="text" class="form-control" placeholder="First Name" name="firstName" id="studentFirstName" required>
                            <div class="mb-3"></div>
                            <input type="text" class="form-control" placeholder="Last Name" name="lastName" id="studentLastName" required>
                            <div class="mb-3"></div>
                            <input type="text" class="form-control" placeholder="School Name" name="schoolName" id="studentSchoolName" required>
                            <div class="mb-3"></div>
                            <input type="email" class="form-control" placeholder="Email" name="email" id="studentEmail" required>
                            <div class="mb-3"></div>
                            <input type="password" class="form-control mb-3" placeholder="Password" name="password" required>
                            <div class="mb-3"></div>
                            <input type="password" class="form-control mb-3" placeholder="Confirm Password" name="confirmPassword" required>
                            <div class="mb-3"></div>
                            <input type="text" name="role" value="student" id="signupRole" hidden>
                            <button type="submit" class="btn btn-sm btn-primary px-4">Signup</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="collapse" id="placeownerSignup">
                <div class="row justify-content-center text-center mb-3">
                    <div class="col-8">
                        <h2 class="display-5 text-white">Sign up as Placeowner</h2>
                    </div>
                </div>
                <form method="POST" action="/signup">
                    <div class="row justify-content-center text-center">
                        <div class="col-8 col-md-6 col-lg-5 col-xl-4 formFields">
                            <input type="text" class="form-control mb-3" placeholder="First Name" name="firstName" id="placeownerFirstName" required>
                            <input type="text" class="form-control mb-3" placeholder="Last Name" name="lastName" id="placeownerLastName" required>
                            <div class="input-group mb-3">
                                <input type="email" class="form-control" placeholder="Email" name="email" id="placeownerEmail" required>
                                <div class="input-group-append">
                                    <span class="input-group-text d-none" id="validitySpan2">
                                        <i class="fas" id="validityIcon2"></i>
                                    </span>
                                </div>
                            </div>
                            <input type="password" class="form-control mb-3" placeholder="Password" name="password" required>
                            <input type="password" class="form-control mb-3" placeholder="Confirm Password" name="confirmPassword" required>
                            <input type="text" name="role" value="placeowner" hidden>
                            <button type="submit" class="btn btn-sm btn-primary px-4">Signup</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="row justify-content-center">
                <button type="button" class="btn text-white bg-transparent mt-3" id="switchToLoginButton">Already signed up? Log in!</button>
            </div>
        </div>
        
    </main>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row text-center text-white justify-content-around align-items-center">
                
                <div class="col-10 col-md-6 mt-3">
                    <h3 class="display-5 pt-2">About Us</h3>
                    <p class="bg-dark p-3 rounded">
                        RS Navi aims to help students who travel long distances to go to school by providing a convenient list of available places to stay near their school.
                    </p>
                </div>
                
                <div class="col-10 col-md-5 mt-3">
                    <form method="POST" action="">
                        <h3 class="display-5">Stay Connected</h3>
                        <div class="input-group mb-3 shadow-lg">
                          <input type="email" class="form-control" placeholder="Email address" name="emailAddress">
                          <div class="input-group-append">
                            <button class="btn btn-dark" type="submit">Sign Up To Newsletter</button>
                          </div>
                        </div>
                        <p class="bg-dark border border-dark rounded">By signing up, you are agreeing to our <a href="" id="privacy" data-toggle="modal" data-target="#exampleModalLong">Privacy Policy</a>.</p>
                    </form>
                </div>
            </div>
            <hr>
            <div class="row justify-content-center text-center">
                <p class="text-white">roomstayin.navigation@gmail.com &copy; Bathtub Coding 2019</p>
            </div>
        </div>
    </footer>
    
    <!-- Modal -->
    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Privacy Policy</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://underscorejs.org/underscore-min.js"></script> <!-- Underscore JS-->
    <!-- My Script -->
    <script src="js/auth.js" type="text/javascript"></script>

    <script>
        $('form').attr('autocomplete', 'off');
        
        // realtime form validation
        $("form").on('submit', function(event) {
            console.log($(this).find(".is-invalid").length)
            if ($(this).find(".is-invalid").length > 0) {
                event.preventDefault();
                event.stopPropagation();
                
                let fields = [];
                $(this).find(".is-invalid").each(function(i, elem) {
                    fields.push(elem.getAttribute('placeholder') || elem.getAttribute('name'));
                })
                alert($(this).find(".is-invalid").length + ' Invalid Field(s):\n' + fields.join(', '));
            }
        })

        $("input[type='text']").keyup(function() {
            
            const input = $(this);
            const name = input.val();
            const res = input.next();
            
            if (name.startsWith(' ')) {
                res.text('Must not start with space')
            } else if (name.match(/[^a-zA-Zñ\s]|\s{2,}/)) {
                res.text('Contains invalid character')
            } else if (name.length == 0) {
                res.text('Cannot be empty');
            } else if (name.length <= 1) {
                res.text('Too short');
            } else if (name.length > 50) {
                res.text('Too long');
            }  else {
                $(this).removeClass('is-invalid').addClass('is-valid');
                $(this).next().removeClass('invalid-feedback').addClass('valid-feedback').text('');
                return; // return as a valid name
            }
            
            // will only execute if at least one of the invalid conditions above are met
            $(this).removeClass('is-valid').addClass('is-invalid');
            $(this).next().removeClass('valid-feedback').addClass('invalid-feedback')
        })

        const validateEmailFunction = function(email, input, res) {
            $.ajax({
                url: '/validate/email',
                data: { email: email },
                success: function(valid) {
                    console.log(valid);
                    valid = valid;
                    console.log(input.attr('id'));
                    if (valid) {
                        if (input.attr('id') == "forgotPasswordEmail") {
                            input.removeClass('is-valid').addClass('is-invalid');
                            res.removeClass('valid-feedback').addClass('invalid-feedback').text('Email does not exist')
                        } else {
                            input.removeClass('is-invalid').addClass('is-valid');
                            res.removeClass('invalid-feedback').addClass('valid-feedback').text('');
                        }
                    } else {
                        if (input.attr('id') == "forgotPasswordEmail") {
                            input.removeClass('is-invalid').addClass('is-valid');
                        } else {
                            input.removeClass('is-valid').addClass('is-invalid');
                            res.removeClass('valid-feedback').addClass('invalid-feedback').text('Email address is already taken');
                        }
                    }
                }
            })
        }

        // client-side rate-limiting
        const throttledValidateEmailFunction = _.throttle(validateEmailFunction, 1000);

        $("input[type='email']").keyup(function() {
        
            const input = $(this);
            const email = input.val();
            const res = input.next();
            
            let valid = false;

            if (email.startsWith(' ')) {
                res.text('Must not start with space')
            } else if (email.match(/[^a-zA-Z0-9.@_]/)) {
                res.text('Contains invalid character')
            } else if (email.length == 0) {
                res.text('Cannot be empty');
            } else if (email.length > 50) {
                res.text('Too long');       // regex: if starts/ends with @ or period, 2 or more @, an @ is preceded by a period
            } else if (!email.includes('@') || email.match(/[@.]$|^[@.]|@[^@]*@|\.@/)) {
                res.text('Invalid email address')
            } else {
                valid = true;
                throttledValidateEmailFunction(email, input, res);
            }
            
            if (!valid) {
                // will only execute if at least one of the invalid conditions above are met
                $(this).removeClass('is-valid').addClass('is-invalid');
                $(this).next().removeClass('valid-feedback').addClass('invalid-feedback')
            }
        })
    </script>
</body>
</html>